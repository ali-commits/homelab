services:
  paperless-ngx:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    container_name: paperless-ngx
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - PAPERLESS_REDIS=redis://paperless-redis:6379
      - PAPERLESS_DBHOST=paperless-db
      - PAPERLESS_DBNAME=paperless
      - PAPERLESS_DBUSER=paperless
      - PAPERLESS_DBPASS=${DB_PASSWORD}
      - PAPERLESS_TIKA_ENABLED=1
      - PAPERLESS_TIKA_GOTENBERG_ENDPOINT=http://paperless-gotenberg:3000
      - PAPERLESS_TIKA_ENDPOINT=http://paperless-tika:9998
      - PAPERLESS_TIME_ZONE=America/New_York
      # Multi-language OCR Configuration
      - PAPERLESS_OCR_LANGUAGES=ara msa eng # Arabic, Malay, English
      - PAPERLESS_OCR_LANGUAGE=eng+ara+msa # Combined language detection
      - PAPERLESS_DATE_PARSER_LANGUAGES=en+ar+ms # Date parsing for multiple languages
      # OCR Performance Optimization
      - PAPERLESS_THREADS_PER_WORKER=4
      - PAPERLESS_TASK_WORKERS=2
      - PAPERLESS_OCR_PAGES=0 # OCR all pages (0 = unlimited)
      - PAPERLESS_OCR_MODE=skip # Skip OCR on pages with existing text
      - PAPERLESS_OCR_CLEAN=clean # Clean documents before OCR
      - PAPERLESS_SECRET_KEY=${SECRET_KEY}
      - PAPERLESS_URL=https://docs.alimunee.com
      - PAPERLESS_CSRF_TRUSTED_ORIGINS=https://docs.alimunee.com
      - PAPERLESS_ALLOWED_HOSTS=docs.alimunee.com,paperless-ngx
      - PAPERLESS_CORS_ALLOWED_HOSTS=https://docs.alimunee.com
      - PAPERLESS_ADMIN_USER=${ADMIN_USER}
      - PAPERLESS_ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - PAPERLESS_ADMIN_MAIL=${ADMIN_EMAIL}
      # Email configuration
      - PAPERLESS_EMAIL_HOST=postfix
      - PAPERLESS_EMAIL_PORT=25
      - PAPERLESS_EMAIL_FROM=paperless@alimunee.com
      - PAPERLESS_EMAIL_USE_TLS=false
      - PAPERLESS_EMAIL_USE_SSL=false
      # Consumer settings
      - PAPERLESS_CONSUMER_POLLING=30
      - PAPERLESS_CONSUMER_DELETE_DUPLICATES=true
      - PAPERLESS_CONSUMER_RECURSIVE=true
      - PAPERLESS_CONSUMER_SUBDIRS_AS_TAGS=true
    volumes:
      - /storage/data/paperless-ngx/data:/usr/src/paperless/data
      - /storage/data/paperless-ngx/media:/usr/src/paperless/media
      - /storage/data/paperless-ngx/consume:/usr/src/paperless/consume
      - /storage/data/paperless-ngx/export:/usr/src/paperless/export
      - /etc/localtime:/etc/localtime:ro
    networks:
      - proxy
      - paperless_internal
      - db_network
      - mail_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.paperless.rule=Host(`docs.alimunee.com`)"
      - "traefik.http.services.paperless.loadbalancer.server.port=8000"
      - "traefik.docker.network=proxy"
      # Watchtower labels
      - "com.centurylinklabs.watchtower.enable=true"
    depends_on:
      - paperless-db
      - paperless-redis
      - paperless-tika
      - paperless-gotenberg
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  paperless-db:
    image: postgres:16-alpine
    container_name: paperless-db
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - POSTGRES_DB=paperless
      - POSTGRES_USER=paperless
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - /storage/data/paperless-ngx/db:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
    networks:
      - paperless_internal
      - db_network
    command: >
      postgres -c shared_preload_libraries=pg_stat_statements -c max_connections=100 -c shared_buffers=128MB -c effective_cache_size=512MB -c maintenance_work_mem=32MB -c checkpoint_completion_target=0.9 -c wal_buffers=8MB -c default_statistics_target=100
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -d paperless -U paperless" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  paperless-redis:
    image: redis:alpine
    container_name: paperless-redis
    restart: unless-stopped
    command: >
      redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru --save 900 1 --save 300 10 --save 60 10000
    volumes:
      - /storage/data/paperless-ngx/redis:/data
      - /etc/localtime:/etc/localtime:ro
    networks:
      - paperless_internal
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  paperless-tika:
    image: apache/tika:latest
    container_name: paperless-tika
    restart: unless-stopped
    networks:
      - paperless_internal
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9998/tika" ]
      interval: 30s
      timeout: 10s
      retries: 3

  paperless-gotenberg:
    image: gotenberg/gotenberg:8
    container_name: paperless-gotenberg
    restart: unless-stopped
    command:
      - "gotenberg"
      - "--chromium-disable-javascript=true"
      - "--chromium-allow-list=file:///tmp/.*"
    networks:
      - paperless_internal
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  proxy:
    external: true
  paperless_internal:
    name: paperless_internal
    driver: bridge
  db_network:
    external: true
    name: db_network
  mail_network:
    external: true
    name: mail_network
