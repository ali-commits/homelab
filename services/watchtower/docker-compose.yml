services:
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    environment:
      - TZ=Asia/Kuala_Lumpur
      - WATCHTOWER_SCHEDULE=0 0 4 * * *
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_ROLLING_RESTART=true
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_WARN_ON_HEAD_FAILURE=true
      - WATCHTOWER_NO_RESTART=false
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    dns:
      - 8.8.8.8
      - 1.1.1.1
    networks:
      - proxy
    labels:
      - com.centurylinklabs.watchtower.enable=false
    security_opt:
      - no-new-privileges:true
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"

  watchtower-notifier:
    image: alpine:latest
    container_name: watchtower-notifier
    restart: unless-stopped
    environment:
      - TZ=Asia/Kuala_Lumpur
    entrypoint: /bin/sh
    command:
      - -c
      - |
        apk add --no-cache curl docker-cli jq
        echo '10 4 * * * /notify.sh' > /etc/crontabs/root
        crond -f -l 2
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./notify-webhook.sh:/notify.sh:ro
    dns:
      - 8.8.8.8
      - 1.1.1.1
    networks:
      - proxy

networks:
  proxy:
    external: true
